# Generated by Django 3.2 on 2023-07-10 03:36

from django.db import migrations, models


def recreate_temp_scopes(apps, schema_editor):
    AuthorizedClient = apps.get_model('oauth2', 'AuthorizedClient')
    Grant = apps.get_model('oauth2', 'Grant')
    AccessToken = apps.get_model('oauth2', 'AccessToken')

    TempScope = apps.get_model('oauth2', 'TempScope')
    Scope = apps.get_model('oauth2', 'Scope')
    scopes = dict()
    for scope in Scope.objects.all():
        scopes[scope.name] = TempScope.objects.create(
            name=scope.name,
            description=scope.description
        )

    for client in AuthorizedClient.objects.all():
        for scope_name in client.scope.all().values_list('name', flat=True):
            client.temp_scope.add(scopes[scope_name].pk)

    for grant in Grant.objects.all():
        for scope_name in grant.scope.all().values_list('name', flat=True):
            grant.temp_scope.add(scopes[scope_name].pk)

    for token in AccessToken.objects.all():
        for scope_name in token.scope.all().values_list('name', flat=True):
            token.temp_scope.add(scopes[scope_name].pk)


def copy_scopes_from_temp(apps, schema_editor):
    AuthorizedClient = apps.get_model('oauth2', 'AuthorizedClient')
    Grant = apps.get_model('oauth2', 'Grant')
    AccessToken = apps.get_model('oauth2', 'AccessToken')

    TempScope = apps.get_model('oauth2', 'TempScope')
    Scope = apps.get_model('oauth2', 'Scope')

    scopes = dict()
    for scope in TempScope.objects.all():
        scopes[scope.name] = Scope.objects.create(
            name=scope.name,
            description=scope.description,
        )

    for client in AuthorizedClient.objects.all():
        for scope_name in client.temp_scope.all().values_list('name', flat=True):
            client.scope.add(scopes[scope_name])

    for grant in Grant.objects.all():
        for scope_name in grant.temp_scope.all().values_list('name', flat=True):
            grant.scope.add(scopes[scope_name])

    for token in AccessToken.objects.all():
        for scope_name in token.temp_scope.all().values_list('name', flat=True):
            token.scope.add(scopes[scope_name])


class Migration(migrations.Migration):

    dependencies = [
        ('oauth2', '0005_delete_scope'),
    ]

    operations = [
        migrations.CreateModel(
            name='Scope',
            fields=[
                ('name', models.CharField(max_length=150, primary_key=True, serialize=False)),
                ('description', models.CharField(blank=True, default='', max_length=256)),
            ],
            options={
                'db_table': 'oauth2_scope',
            },
        ),
        migrations.AddField(
            model_name='accesstoken',
            name='scope',
            field=models.ManyToManyField(to='oauth2.Scope'),
        ),
        migrations.AddField(
            model_name='authorizedclient',
            name='scope',
            field=models.ManyToManyField(to='oauth2.Scope'),
        ),
        migrations.AddField(
            model_name='grant',
            name='scope',
            field=models.ManyToManyField(to='oauth2.Scope'),
        ),
        migrations.RunPython(copy_scopes_from_temp, recreate_temp_scopes)
    ]
